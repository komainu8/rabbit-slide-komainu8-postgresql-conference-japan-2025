# PostgreSQLでのセマンティックサーチへの挑戦

author
: 堀本 泰弘

institution
: 株式会社クリアコード

content-source
: PostgreSQL Conference Japan 2025

date
: 2025-11-21

start-time
: 2025-11-21T16:20:00+09:00

end-time
: 2025-11-21T17:05:00+09:00

theme
: .

# 本日の内容

1. キーワード検索の課題と改善の方向性
2. セマンティックサーチを実現するために
3. RaBitQを採用した理由
4. PGroongaから使うセマンティックサーチ
5. 用例：FAQ検索・ナレッジベース検索の高度化
6. 今後の展望

# 本日の内容

1. **キーワード検索の課題と改善の方向性**
2. セマンティックサーチを実現するために
3. RaBitQを採用した理由
4. PGroongaから使うセマンティックサーチ
5. 用例：FAQ検索・ナレッジベース検索の高度化
6. 今後の展望

# 1. キーワード検索の課題と改善の方向性

キーワード検索は、単語の文字列を一致させるため、同義語や言い換え表現、曖昧な表現には弱いという課題があります。
例えば、「牛乳」と「ミルク」など、意味的には関連していても異なる表現だと検索に引っかかりにくい問題があります。
また、キーワード検索はスペルミスや表記ゆれなどの対応にも工夫がいります。

改善の方向性としては、セマンティックサーチの導入が挙げられます。
セマンティックサーチは文章の意味を理解して検索を行うため、同義語や関連語も考慮し、「意味的に近い」情報を引き出せる点が特徴です。
これにより、ユーザーが違う言い方をしても、同じ意図の情報を見つけやすくなり、必要な情報の取りこぼしを減らせます。
スペルミスや表記ゆれなどにも対応できます。

ひとつ注意したいのはキーワード検索とセマンティック検索は対立しないということです。
どちらか一方のほうが優れているとかではなく両者を組み合わせることで検索精度と利便性が向上します。

# セマンティックサーチとは？

| 従来の検索 | 字面で検索 |
| セマンティックサーチ | 意味で検索 |

# セマンティックサーチの利点

意味で検索できると何が良いのでしょうか？

# 字面で検索

検索キーワード：「牛乳」

「牛乳」：Match！
「ミルク」：Not match！

# 字面で検索

形が違うとヒットしない

# 意味で検索

検索キーワード：「牛乳」

「牛乳」：Match！
「ミルク」：Match！

# 意味で検索

形が違ってもヒットする

# セマンティックサーチの利点

| 字面での検索 | 「牛乳」と「ミルク」は違うもの |
| 意味での検索 | 「牛乳」と「ミルク」は同じようなもの |

# 字面が違う文字列の検索

従来の検索では、字面が違う文字列をどうやって検索しているのでしょうか？

# 字面が違う文字列の検索

同義語辞書

# 同義語辞書のデメリット

メンテナンスコスト：高い
未知語への対応：辞書に未定義だと対応できない

# セマンティックサーチの利点

辞書のメンテナンスコスト：なし（辞書不要）
未知語への対応：一般的な語なら辞書なしでも対応できる

# セマンティックサーチの利点

誤記にも対応できる

# セマンティックサーチの利点

「テクノロジー」と「テノクロジー」

# セマンティックサーチの利点

類似度がわかるので、類似度の高いものから表示することで、価値の高いデータにたどり着きやすい

# 再掲: 本日の内容

1. ~~キーワード検索の課題と改善の方向性~~
2. **セマンティックサーチを実現するために**
3. RaBitQを採用した理由
4. PGroongaから使うセマンティックサーチ
5. 用例：FAQ検索・ナレッジベース検索の高度化
6. 今後の展望

# 2. セマンティックサーチを実現するために

セマンティックサーチは、先ほども説明した通り単にキーワードの一致を確認する従来の検索とは異なり、検索クエリの意味や文脈を理解して関連性の高い情報を提供する検索技術です。

セマンティックサーチを実現するためには、まず大規模言語モデル（LLM）を使ってテキストをベクトル化する技術が必要です。
LLMは文章の意味や文脈を理解し、文章を高次元の数値表現（ベクトル）に変換します。
このベクトル化により、意味的に類似した文や単語が近い位置にマッピングされ、単なる文字列一致ではなく意味での比較が可能になります。

次に、ベクトル化されたデータ間の近さ（類似度）を計算するベクトル検索技術が必要です。
検索時には、検索対象のテキストと検索クエリのテキストそれぞれをベクトルに変換し、そのベクトル同士の近さ（類似度）を計算する必要があるためです。
この処理は検索対象となる膨大なベクトルの中から、検索クエリのベクトルに近いデータを高速に探し出す必要があるため、効率的なインデックス構造やアルゴリズムが重要となります。

このように、LLMによるベクトル化と高速かつ高精度なベクトル検索の技術が、セマンティックサーチ実現の鍵となっています。

# セマンティクサーチの仕組み

では、意味で検索の「意味」とはなんでしょうか？

# セマンティクサーチの仕組み

「意味」 = ベクトル

# セマンティクサーチの仕組み

テキストデータ -> LLM -> ベクトル

# セマンティクサーチの仕組み

「意味」の近い/遠い -> ベクトル同士の距離

# セマンティクサーチの仕組み

1. 登録するデータ -> LLM -> ベクトルデータ
2. 検索キーワード -> LLM -> ベクトルデータ

1と2の距離（類似度）を計算

# セマンティクサーチの仕組み

ベクトル表現することで”距離が計算できる”

# セマンティクサーチの仕組み

距離や類似度のおもな計算方法

* ユークリッド距離
* マンハッタン距離
* コサイン類似度

# セマンティックサーチの課題

距離（類似度）を計算して検索を実行

# セマンティックサーチの課題

すべてのベクトルデータの距離を計算？：X

# セマンティックサーチの課題

線形探索になってしまう

# セマンティックサーチの課題

検索対象のデータをすべてベクトルデータに変換して保持？

# セマンティックサーチの課題

大規模なデータでサイズが非常に大きくなる

# セマンティックサーチの課題

データサイズが大きいとメモリーに乗らず遅い

# 再掲: 本日の内容

1. ~~キーワード検索の課題と改善の方向性~~
2. ~~セマンティックサーチを実現するために~~
3. **RaBitQを採用した理由**
4. PGroongaから使うセマンティックサーチ
5. 用例：FAQ検索・ナレッジベース検索の高度化
6. 今後の展望

# 解決方法

線形探索：近似最近傍検索
データサイズ：圧縮

# 近似最近傍検索

ある程度の正確性を捨てて、入力したベクトルデータとだいたい同じデータを探します

# ベクトルデータの圧縮

ベクトルデータの圧縮方法はいくつかありますが今回PGroongaで採用したのはRaBitQという圧縮方法です

# 3. RaBitQを採用した理由

効率的なインデックス構造のためにRaBitQを採用しました。
RaBitQの詳細を説明するとそれのみでひとつの発表になるので、非常に簡単に説明し採用の理由を説明します。

RaBitQの特徴:

* 32ビット浮動小数点数のベクトルを 1ビットに圧縮する手法
  * データは正・負の1ビットデータ
  * **単純計算でデータ量が1/32になる**
  * ベクトルの量子化と言われる
* それだけ圧縮してもデータの向き情報を保つように工夫されている
* 計算対象が1ビットのデータなので **計算も高速に行える**
  * SIMDと組み合わせるとより高速に計算できる

RaBitQを採用した理由:

* データ量が少ない！
* 高速に計算できる！

# IVFとHNSWについて

* IVF
  * Inverted File
  * ベクトル空間をクラスタリングして、対象クラスタ内で探索
  * ...
* HNSW
  * Hierarchical Navigable Small World
  * グラフを階層構造で構築して、効率的に探索する
  * ...

（TODO 当日までまとめる）

# 再掲: 本日の内容

1. ~~キーワード検索の課題と改善の方向性~~
2. ~~セマンティックサーチを実現するために~~
3. ~~RaBitQを採用した理由~~
4. **PGroongaから使うセマンティックサーチ**
5. 用例：FAQ検索・ナレッジベース検索の高度化
6. 今後の展望

# PGroongaについて

PostgreSQLでセマンティックサーチを行うにあたり、**PGroonga**から利用できる形で実装しました。
そこでまずはPGroongaについて簡単に紹介し、PGroongaからどのようにセマンティックサーチを使うのかを紹介します。

PGroonga（ぴーじーるんが）はPostgreSQLの拡張機能で、全言語対応の超高速全文検索機能を提供します。

PGroongaは全文検索エンジン「Groonga」をPostgreSQLのインデックス機構として統合したものです。
PostgreSQLに保存されたデータをそのまま検索対象にできるため、外部検索エンジンと違い、別のシステムへのデータ転送や同期を行わない「ゼロETL」で利用できます。

また、PGroongaは既存のSQL構文をほぼそのまま利用できる設計になっており、PostgreSQLユーザーにとって学習コストが非常に低いのが特徴です。

PGroongaのドキュメント: https://pgroonga.github.io/ja/

# 4. PGroongaから使うセマンティックサーチ

PGroongaには「既存のSQL構文をほぼそのまま利用でき、PostgreSQLユーザーにとって学習コスト低い」という特徴があります。
セマンティックサーチについてもその特徴を引き継ぎ、次のように簡単に利用できるようにしています。

ユーザーにベクトルの扱いを遮蔽し、セマンティックサーチを使いやすくしています。
具体的には、ユーザーは単にテキストデータをINSERTするだけ利用できます。
ベクトルはPGroongaが内部的に自動で生成します。
これにより、ユーザーはベクトルの生成や管理の複雑さから解放され、純粋にテキストベースの操作に集中できます。

さらに、検索や比較においても、普段のSQLに近い形でテキスト同士の比較が可能です。
これは、ベクトル演算の理解や特別な関数を習得する必要がなく、SQLの基本的な知識だけで扱えるということを意味します。

この特徴によって、セマンティックサーチの導入や運用のハードルを下げ、より直感的で効率的な利用が可能になります。

# PGroongaの性能

ベクトルの生成を内部で行うため、INSERT時の処理コストが増加することが想定されます。
また、ベクトル情報を保持する分インデックスサイズも増加します。
これらの性能面については具体的な計測を実施し、その結果についても当日に発表いたします。

# 再掲: 本日の内容

1. ~~キーワード検索の課題と改善の方向性~~
2. ~~セマンティックサーチを実現するために~~
3. ~~RaBitQを採用した理由~~
4. ~~PGroongaから使うセマンティックサーチ~~
5. **用例：FAQ検索・ナレッジベース検索の高度化**
6. 今後の展望

# 5. 用例：FAQ検索・ナレッジベース検索の高度化

実際の課題に適用して例を記載。
RAGについても言及する。
発表当日に詳細を紹介。

# 再掲: 本日の内容

1. ~~キーワード検索の課題と改善の方向性~~
2. ~~セマンティックサーチを実現するために~~
3. ~~RaBitQを採用した理由~~
4. ~~PGroongaから使うセマンティックサーチ~~
5. ~~用例：FAQ検索・ナレッジベース検索の高度化~~
6. **今後の展望**

# 6. 今後の展望

* リアルタイム性
* 速度
* RAGでの活用
* ...
